<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin - MEDI-GO</title>
    <!-- Chart.js para gr치ficos bonitos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            padding: 0; margin: 0;
            display: none; /* Come칞a oculto por seguran칞a */
        }
        
        /* Barra lateral e Layout */
        .layout { display: flex; min-height: 100vh; }
        .sidebar {
            width: 250px;
            background: #1e293b;
            padding: 20px;
            border-right: 1px solid #334155;
        }
        .content { flex: 1; padding: 30px; }

        h1 { color: #38bdf8; font-size: 24px; margin-bottom: 5px; }
        .subtitle { color: #94a3b8; font-size: 14px; margin-bottom: 30px; }

        /* Cards de Estat칤sticas (KPIs) */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .kpi-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .kpi-value { font-size: 32px; font-weight: bold; color: #fff; }
        .kpi-label { color: #94a3b8; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }

        /* 츼rea dos Gr치ficos */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-container {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
        }

        /* Tabelas de Dados Brutos */
        .data-section {
            background: #1e293b;
            border-radius: 12px;
            border: 1px solid #334155;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .data-header {
            padding: 15px 20px;
            background: #334155;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .timestamp { font-size: 12px; color: #cbd5e1; font-weight: normal; }
        
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; background: #0f172a; color: #94a3b8; padding: 12px 20px; }
        td { padding: 12px 20px; border-bottom: 1px solid #334155; color: #cbd5e1; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #273548; }

        button.refresh {
            background: #38bdf8; color: #0f172a; border: none;
            padding: 10px 20px; border-radius: 8px; font-weight: bold;
            cursor: pointer; transition: all 0.2s;
        }
        button.refresh:hover { background: #7dd3fc; transform: translateY(-1px); }
    </style>
</head>
<body>

<div class="layout">
    <div class="sidebar">
        <div style="font-weight:900; font-size:20px; color:white; margin-bottom:40px;">MEDI-GO <span style="color:#38bdf8">ADMIN</span></div>
        <div style="color:#94a3b8; font-size:14px;">
            <p>Dashboard</p>
            <p>Auditoria</p>
            <p>Logs do Sistema</p>
        </div>
        <div style="margin-top:auto; color:#64748b; font-size:12px;">
            Vers칚o 2.1<br>Conectado via Firebase SDK
        </div>
    </div>

    <div class="content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div>
                <h1>Dashboard Anal칤tico</h1>
                <div class="subtitle">Vis칚o geral em tempo real da base de dados.</div>
            </div>
            <button class="refresh" onclick="location.reload()">游댃 Atualizar</button>
        </div>

        <!-- KPIs (Indicadores) -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Total de Usu치rios</div>
                <div class="kpi-value" id="kpi-users">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Idosos Monitorados</div>
                <div class="kpi-value" id="kpi-elders">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Alarmes Ativos</div>
                <div class="kpi-value" id="kpi-alarms">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Consultas Agendadas</div>
                <div class="kpi-value" id="kpi-appts">-</div>
            </div>
        </div>

        <!-- Gr치ficos -->
        <div class="charts-grid">
            <div class="chart-container">
                <canvas id="chartUsers"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="chartActivity"></canvas>
            </div>
        </div>

        <h3 style="margin-top:40px; margin-bottom:20px; color:#fff;">Dados Brutos (Tabelas)</h3>
        <div id="raw-data-area">Carregando tabelas...</div>

    </div>
</div>

<!-- FIREBASE (Obrigat칩rio para ler o banco) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    const SENHA_MESTRA = "admin123";
    
    const input = prompt("游댏 ACESSO RESTRITO\nDigite a senha de administrador:");
    if (input === SENHA_MESTRA) {
        document.body.style.display = "block"; 
    } else {
        alert("Acesso Negado.");
        window.location.replace("index.html");
    }

    const firebaseConfig = {
        apiKey: "AIzaSyDdeLTGazq7qSahG4fYUtAWorndqaFCCJI",
        authDomain: "projeto-a3-medi-go.firebaseapp.com",
        projectId: "projeto-a3-medi-go",
        storageBucket: "projeto-a3-medi-go.firebasestorage.app",
        messagingSenderId: "450701155898",
        appId: "1:450701155898:web:cd19ba0871aed011c55f03",
        measurementId: "G-B2F1DD5QDF"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function initDashboard() {
        const area = document.getElementById('raw-data-area');
        area.innerHTML = '';

        try {
            const snapshot = await db.collection('projeto_escola').get();
            
            let stats = {
                users: 0, cuidador: 0, idoso: 0,
                elders: 0, alarms: 0, appts: 0, activity: 0
            };

            if (snapshot.empty) {
                area.innerHTML = "Banco de dados vazio.";
                return;
            }

            snapshot.forEach(doc => {
                const id = doc.id; 
                const data = doc.data();
                const items = data.dados || [];

                if(id === 'users' && Array.isArray(items)) {
                    stats.users = items.length;
                    items.forEach(u => {
                        if(u.role === 'cuidador') stats.cuidador++;
                        else stats.idoso++;
                    });
                }
                if(id === 'elders' && Array.isArray(items)) stats.elders = items.length;
                if(id === 'alarms' && Array.isArray(items)) stats.alarms = items.length;
                if(id === 'appts' && Array.isArray(items)) stats.appts = items.length;
                if(id === 'activity' && Array.isArray(items)) stats.activity = items.length;

                renderTable(id, items, data.ultimoUpdate, area);
            });

            document.getElementById('kpi-users').textContent = stats.users;
            document.getElementById('kpi-elders').textContent = stats.elders;
            document.getElementById('kpi-alarms').textContent = stats.alarms;
            document.getElementById('kpi-appts').textContent = stats.appts;

            renderCharts(stats);

        } catch (error) {
            area.innerHTML = `<div style="color:red">Erro ao ler banco: ${error.message}</div>`;
            console.error(error);
        }
    }

    function renderTable(collectionName, data, updateTime, container) {
        if (!Array.isArray(data) || data.length === 0) return;

        const section = document.createElement('div');
        section.className = 'data-section';
        
        let html = `
            <div class="data-header">
                <span>游늭 ${collectionName.toUpperCase()}</span>
                <span class="timestamp">Atualizado: ${new Date(updateTime).toLocaleString()}</span>
            </div>
            <table><thead><tr>`;
        
        const keys = Object.keys(data[0]).slice(0, 5);
        keys.forEach(k => html += `<th>${k}</th>`);
        html += `</tr></thead><tbody>`;

        data.slice(0, 10).forEach(row => {
            html += `<tr>`;
            keys.forEach(k => {
                let val = row[k];
                if(typeof val === 'object') val = JSON.stringify(val);
                html += `<td>${val}</td>`;
            });
            html += `</tr>`;
        });
        html += `</tbody></table>`;

        if(data.length > 10) {
            html += `<div style="padding:10px; text-align:center; color:#64748b; font-size:12px;">+ ${data.length - 10} registros ocultos</div>`;
        }

        section.innerHTML = html;
        container.appendChild(section);
    }

    let userChartInstance = null;
    let activityChartInstance = null;
    
    function renderCharts(stats) {
        if (userChartInstance) userChartInstance.destroy();
        if (activityChartInstance) activityChartInstance.destroy();

        userChartInstance = new Chart(document.getElementById('chartUsers'), {
            type: 'doughnut',
            data: {
                labels: ['Cuidadores', 'Idosos'],
                datasets: [{
                    data: [stats.cuidador, stats.idoso],
                    backgroundColor: ['#38bdf8', '#10b981'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#cbd5e1' } },
                    title: { display: true, text: 'Distribui칞칚o de Usu치rios', color: '#fff' }
                }
            }
        });

        activityChartInstance = new Chart(document.getElementById('chartActivity'), {
            type: 'bar',
            data: {
                labels: ['Alarmes', 'Consultas', 'Idosos', 'Logs'],
                datasets: [{
                    label: 'Registros',
                    data: [stats.alarms, stats.appts, stats.elders, stats.activity],
                    backgroundColor: '#6366f1',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                    x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                },
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Volume de Dados no Sistema', color: '#fff' }
                }
            }
        });
    }

    initDashboard();
</script>

</body>
</html>